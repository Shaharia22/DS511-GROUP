<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Class Group Portal</title>
    <style>
        :root { --primary: #2563eb; --danger: #ef4444; --bg: #f8fafc; --text: #1e293b; }
        body { font-family: 'Inter', system-ui, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; }
        .container { max-width: 1100px; margin: 0 auto; }
        header { text-align: center; margin-bottom: 30px; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        h1 { margin: 0; color: var(--primary); }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 20px; }
        .card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); border: 1px solid #e2e8f0; }
        .group-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 2px solid #f1f5f9; padding-bottom: 10px; }
        .group-title { font-weight: bold; cursor: pointer; color: var(--primary); }
        .count { font-size: 0.8rem; background: #e2e8f0; padding: 2px 8px; border-radius: 10px; }
        .member-row { display: flex; justify-content: space-between; background: #f8fafc; padding: 10px; margin: 5px 0; border-radius: 6px; border-left: 4px solid var(--primary); font-size: 0.9rem; }
        .remove-btn { color: var(--danger); border: none; background: none; cursor: pointer; font-weight: bold; }
        .inputs { margin-top: 15px; display: flex; flex-direction: column; gap: 8px; }
        input { padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px; }
        .join-btn { background: var(--primary); color: white; border: none; padding: 10px; border-radius: 6px; cursor: pointer; font-weight: 600; }
        .full-msg { text-align: center; color: var(--danger); font-size: 0.8rem; font-weight: bold; margin-top: 10px; }
        #loader { position: fixed; top: 10px; right: 10px; background: #1e293b; color: white; padding: 8px 15px; border-radius: 20px; display: none; font-size: 0.8rem; }
    </style>
</head>
<body>

<div id="loader">Processing...</div>

<div class="container">
    <header>
        <h1>Group Formation Hub</h1>
        <p>Real-time sync enabled. Max 6 members per group.</p>
    </header>
    <div class="grid" id="mainGrid"></div>
</div>

<script>
    const BIN_ID = "698f137aae596e708f27cbf9";
    const API_KEY = "$2a$10$Qh6w2BJC0RLQ/T/UCryTe.hDIEFVgBJ5SSJLHJ.WYCDC0ZrBYeeWS";
    const URL = `https://api.jsonbin.io/v3/b/${BIN_ID}`;
    const MAX = 6;

    let groupData = [];

    // --- CLOUD LOGIC ---
    async function loadData() {
        toggleLoader(true);
        try {
            const res = await fetch(`${URL}/latest`, { headers: { "X-Master-Key": API_KEY } });
            const data = await res.json();
            groupData = data.record;
            render();
        } catch (e) { console.error("Load Error"); }
        toggleLoader(false);
    }

    async function saveData() {
        toggleLoader(true);
        try {
            await fetch(URL, {
                method: 'PUT',
                headers: { "Content-Type": "application/json", "X-Master-Key": API_KEY },
                body: JSON.stringify(groupData)
            });
            render();
        } catch (e) { alert("Save failed!"); }
        toggleLoader(false);
    }

    function toggleLoader(show) { document.getElementById('loader').style.display = show ? 'block' : 'none'; }

    // --- APP LOGIC ---
    function join(groupId) {
        const idIn = document.getElementById(`id-${groupId}`);
        const nameIn = document.getElementById(`name-${groupId}`);
        const id = idIn.value.replace(/\D/g, ''); // Number only
        const name = nameIn.value.trim();

        if (!id || !name) return alert("Enter ID (numbers only) and Name!");
        if (groupData.some(g => g.members.some(m => m.id === id))) return alert("ID already in a group!");

        const group = groupData.find(g => g.id === groupId);
        if (group.members.length < MAX) {
            group.members.push({ id, name });
            saveData();
        }
    }

    function remove(groupId, studentId) {
        if (confirm("Leave this group?")) {
            const group = groupData.find(g => g.id === groupId);
            group.members = group.members.filter(m => m.id !== studentId);
            saveData();
        }
    }

    function rename(groupId) {
        const group = groupData.find(g => g.id === groupId);
        const newTitle = prompt("Edit Group Name:", group.groupTitle);
        if (newTitle) {
            group.groupTitle = newTitle;
            saveData();
        }
    }

    function render() {
        const grid = document.getElementById('mainGrid');
        grid.innerHTML = '';
        groupData.forEach(group => {
            const isFull = group.members.length >= MAX;
            const card = document.createElement('div');
            card.className = 'card';
            card.innerHTML = `
                <div class="group-header">
                    <span class="group-title" onclick="rename(${group.id})">${group.groupTitle} ✎</span>
                    <span class="count">${group.members.length}/${MAX}</span>
                </div>
                <div class="list">
                    ${group.members.map(m => `
                        <div class="member-row">
                            <span><b>${m.id}</b> - ${m.name}</span>
                            <button class="remove-btn" onclick="remove(${group.id}, '${m.id}')">✕</button>
                        </div>
                    `).join('')}
                </div>
                ${!isFull ? `
                    <div class="inputs">
                        <input type="text" id="id-${group.id}" placeholder="Student ID (Numbers)" oninput="this.value=this.value.replace(/[^0-9]/g,'')">
                        <input type="text" id="name-${group.id}" placeholder="Full Name">
                        <button class="join-btn" onclick="join(${group.id})">Join</button>
                    </div>
                ` : `<div class="full-msg">GROUP FULL</div>`}
            `;
            grid.appendChild(card);
        });
    }

    loadData();
</script>
</body>
</html>
